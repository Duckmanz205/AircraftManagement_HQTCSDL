@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="p-6">
    <h2 class="text-2xl font-bold mb-4">Danh Sách Chuyến Bay (API Load)</h2>

    <button onclick="loadFlights()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-4">
        <i class="fas fa-sync-alt mr-2"></i> Tải lại dữ liệu
    </button>

    <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã CB</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Máy Bay</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hãng</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lộ Trình</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giờ Bay</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng Thái</th>
                </tr>
            </thead>
            <tbody id="flightTableBody" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="6" class="text-center py-4 text-gray-500">Đang tải dữ liệu...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Hàm gọi API
    function loadFlights() {
        const tbody = document.getElementById('flightTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Đang tải...</td></tr>';

        fetch('/api/ChuyenBayAPI/GetAllFlights')
            .then(response => {
                if (!response.ok) throw new Error('Lỗi kết nối API');
                return response.json();
            })
            .then(data => {
                tbody.innerHTML = ''; // Xóa loading

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Không có dữ liệu</td></tr>';
                    return;
                }

                data.forEach(item => {
                    // Xử lý ngày giờ cho đẹp
                    let routeInfo = '--';
                    let timeInfo = '--';

                    if (item.LoTrinh) {
                        routeInfo = `${item.LoTrinh.SanBayDi} &rarr; ${item.LoTrinh.SanBayDen}`;

                        // Format ngày giờ (cần xử lý chuỗi ISO trả về từ API)
                        const dep = new Date(item.LoTrinh.GioCatCanh);
                        timeInfo = dep.toLocaleString('vi-VN');
                    }

                    // Xác định màu trạng thái
                    let statusClass = 'bg-gray-100 text-gray-800';
                    if(item.TrangThai === 'Đúng giờ') statusClass = 'bg-green-100 text-green-800';
                    if(item.TrangThai === 'Hủy') statusClass = 'bg-red-100 text-red-800';

                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-blue-600">${item.MaCB}</td>
                            <td class="px-6 py-4 text-gray-900">${item.MayBay}</td>
                            <td class="px-6 py-4 text-gray-500">${item.Hang}</td>
                            <td class="px-6 py-4 text-gray-900">${routeInfo}</td>
                            <td class="px-6 py-4 text-gray-500">${timeInfo}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                    ${item.TrangThai}
                                </span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Lỗi: ${error.message}</td></tr>`;
            });
    }

    // Tự động tải khi vào trang
    document.addEventListener('DOMContentLoaded', loadFlights);
</script>